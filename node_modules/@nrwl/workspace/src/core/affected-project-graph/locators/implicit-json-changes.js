"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const json_diff_1 = require("../../../utils/json-diff");
exports.getImplicitlyTouchedProjectsByJsonChanges = (touchedFiles, workspaceJson, nxJson) => {
    const { implicitDependencies } = nxJson;
    if (!implicitDependencies) {
        return [];
    }
    const touched = [];
    for (const f of touchedFiles) {
        if (f.file.endsWith('.json') && implicitDependencies[f.file]) {
            const changes = f.getChanges();
            for (const c of changes) {
                if (json_diff_1.isJsonChange(c)) {
                    const projects = getTouchedProjects(c.path, implicitDependencies[f.file]) || [];
                    projects.forEach((p) => touched.push(p));
                }
                else {
                    const projects = getTouchedProjectsByJsonFile(implicitDependencies, f.file);
                    projects.forEach((p) => touched.push(p));
                }
            }
        }
    }
    return touched;
};
function getTouchedProjectsByJsonFile(implicitDependencies, file) {
    let projects = [];
    json_diff_1.walkJsonTree(implicitDependencies[file], [], (p, value) => {
        if (Array.isArray(value)) {
            projects.push(...value);
        }
        return !Array.isArray(value);
    });
    return projects;
}
function getTouchedProjects(path, implicitDependencyConfig) {
    let curr = implicitDependencyConfig;
    let found = true;
    for (const key of path) {
        if (curr[key]) {
            curr = curr[key];
        }
        else {
            found = false;
            break;
        }
    }
    return found && Array.isArray(curr) ? curr : [];
}
//# sourceMappingURL=implicit-json-changes.js.map